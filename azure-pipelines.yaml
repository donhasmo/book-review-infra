trigger:
  paths:
    include:
      - terraform/**
  branches:
    include:
      - main

stages:
- stage: Terraform
  displayName: 'Provision Infrastructure'
  jobs:
  - job: Terraform_Apply
    displayName: 'Terraform Apply'
    pool:
      name: 'linux-hosted-agent'
    steps:

    # üîë Download the SSH public key from secure files
    - task: DownloadSecureFile@1
      name: download_ssh_key
      inputs:
        secureFile: 'id_rsa.pub'

    # üìÇ Copy SSH key to Terraform compute module
    - script: |
        echo "Copying SSH public key into Terraform module"

        mkdir -p ~/.ssh
        cp "$(download_ssh_key.secureFilePath)" ~/.ssh/id_rsa.pub

        # Copy into Terraform compute module
        mkdir -p terraform/modules/compute
        cp "$(download_ssh_key.secureFilePath)" terraform/modules/compute/id_rsa.pub

        echo "Listing contents of terraform/modules/compute/"
        ls -al terraform/modules/compute/
      displayName: 'Extract SSH Public Key for Terraform'


    # üîç Diagnostic Step: verify paths and files
    - script: |
        echo "=== DEBUG INFO ==="
        echo "Current working directory:"
        pwd
        echo ""
        echo "Listing files recursively under terraform/:"
        ls -R terraform || echo "‚ùå Terraform folder not found!"
        echo "==================="
      displayName: "Debug: Verify Terraform path and workspace contents"


    # üß∞ Ensure Terraform CLI is installed globally
    - script: |
        echo "Checking if Terraform is installed..."
        if command -v terraform >/dev/null 2>&1; then
          echo "‚úÖ Terraform is already installed:"
          terraform -version
        else
          echo "‚öôÔ∏è Terraform not found ‚Äî installing globally..."
          TERRAFORM_VERSION="1.9.8"

          sudo apt-get update -y
          sudo apt-get install -y wget unzip

          wget -q https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          sudo unzip -o terraform_${TERRAFORM_VERSION}_linux_amd64.zip -d /usr/local/bin/
          sudo chmod +x /usr/local/bin/terraform

          echo "‚úÖ Terraform installed successfully:"
          terraform -version
        fi
      displayName: "Quick Check or Install Terraform"


    # ‚òÅÔ∏è Terraform Init/Plan/Apply
    - task: AzureCLI@2
      inputs:
        azureSubscription: 'it-azure-connection'
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          echo "##[group]Terraform Init/Plan/Apply"

          echo "Current working directory: $(pwd)"
          ls -al

          # Ensure Terraform binary is available
          which terraform || { echo "‚ùå Terraform not found in PATH"; exit 1; }

          terraform init -input=false
          terraform plan -input=false -var-file="envs/dev.tfvars"
          terraform apply -input=false -auto-approve -var-file="envs/dev.tfvars"

          echo "##[endgroup]"
